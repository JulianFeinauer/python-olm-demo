<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"
            integrity="sha512-Y5n0fbohPllOQ21fTwM/h9sQQ/1a1h5KhweGhu2zwD8lAoJnTgVa7NIrFa1bRDIMQHixtyuRV2ubIx+qWbGdDA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="olm/olm.js"></script>
</head>
<body>
<script>
    // client = new WebSocket("wss://julianfeinauer:drg_vBYwfh_PR9OxXSVHaodVSxu1FFEqIpUHiQNKP2xhNSR@websocket-integration-drogue-dev.apps.wonderful.iot-playground.org/e2e-demo", [])
    //
    // client.onopen = function(e) {
    //   console.log("Opened...")
    // };

    var session

    Olm.init().then(() => {
        console.log("OLM Initialized")

        ses = new Olm.OutboundGroupSession()
        ses.create()

        console.log(ses.session_key())
        console.log(ses.message_index())

        session = new Olm.InboundGroupSession()

        // TODO Session data has to be entered here
        session.create("AgAAAACnHp5+c878lXBRcGSf1TmXAIM+/Y2qZMJhJepA40zlrO5fgVfnMU7CwCzNQEgYE3iEFeFKiFzfC8hP/L1U3mBO2M4igr59q7YdJJvJb6nhKalWycgJmd7jctx01wXSqVeEmBHiu+GAmu/0z4XhP5YtycXtGF0vruVlxZB8/fkThZXaCtbZUG3YwKsQ+bhKP2OX7xxr7YuNpmRnTcyCDNnI6d5frrmsp4nBKgt4eZjajKegeHuNzcTl4QWA9IMAtBV1Ed/yImwhh4+xQQ1mx2H5rCrToQlSUQnd28UcyngfBw")
    })



    var client = new Paho.Client("mqtt-integration-ws-browser-drogue-dev.apps.wonderful.iot-playground.org", 443, "/mqtt", "clientId");

    client.connect({
        useSSL:true,
        reconnect: true,
        mqttVersion: 4,
        userName: "julianfeinauer",
        password: "drg_vBYwfh_PR9OxXSVHaodVSxu1FFEqIpUHiQNKP2xhNSR",
        onSuccess: onConnect,
        onFailure: onFailure
    });

    client.onMessageArrived = function(msg) {
        let data = atob(JSON.parse(msg.payloadString).data_base64)
        console.log("Message: ", data)
        try {
            let plaintext = session.decrypt(data)
            console.log("Plaintext: ", plaintext.plaintext)
        } catch (e) {
            console.log("Error ", e)
        }
    };


    function onFailure(e) {
        console.log("Error: ", e)
    }
    // called when the client connects
    function onConnect() {
      // Once a connection has been made, make a subscription and send a message.
      console.log("onConnect");
      client.subscribe("app/e2e-demo");
    }
</script>
<div id="messages"></div>
</body>
</html>
